import{u as Q,r as o,e as X,j as e,_ as E}from"./index-ef4083ce.js";import{L as J}from"./LocationSelector-a0b5afa8.js";import{B as Z}from"./BackToHomeButton-ed2d2b44.js";const se=()=>{const{t:r}=Q(),[T,D]=o.useState(""),[c,R]=o.useState(""),[g,w]=o.useState(""),[b,B]=o.useState([]),[W,z]=o.useState(!1),[j,C]=o.useState(""),[F,M]=o.useState(!1),[I,N]=o.useState(!1),[U,S]=o.useState(!1),[l,d]=o.useState(""),m=o.useRef(null);o.useEffect(()=>{g?(M(!0),P(g)):c&&(M(!0),P(c))},[g,c]);const P=async t=>{z(!0);try{const _=X(t).map((i,u)=>({id:u+1,crop:i.name,min:i.min,max:i.max,avg:Math.round((i.min+i.max)/2),unit:i.unit||"Qtl",trend:Math.random()>.5?"up":"down"}));B(_)}catch(s){console.error("Failed to fetch mandi rates",s),B([])}finally{z(!1)}},H=()=>W?e.jsxs("div",{className:"card",style:{padding:"3rem",textAlign:"center"},children:[e.jsx("div",{className:"spinner"}),e.jsx("p",{style:{marginTop:"1rem",color:"#666"},children:r("loading_rates")||"Loading..."})]}):F?b.length===0?e.jsxs("div",{style:{textAlign:"center",padding:"3rem",backgroundColor:"#fff",borderRadius:"var(--radius-lg)",border:"2px dashed #cbd5e1"},children:[e.jsx("div",{style:{fontSize:"3rem",marginBottom:"1rem",opacity:.5},children:"ðŸƒ"}),e.jsx("h3",{style:{color:"#64748b",marginBottom:"0.5rem"},children:r("no_results")||"No rates found"}),e.jsx("p",{style:{color:"#94a3b8"},children:"Try selecting a different mandi or district."})]}):e.jsxs("div",{className:"card",style:{overflow:"hidden",padding:0},children:[e.jsxs("div",{style:{padding:"1rem",backgroundColor:"var(--color-secondary)",color:"white",display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs("h3",{style:{margin:0},children:[g||c," Market"]}),e.jsxs("span",{style:{fontSize:"0.9rem"},children:["ðŸ“… ",new Date().toLocaleDateString("en-IN")]})]}),e.jsx("div",{style:{overflowX:"auto"},children:e.jsxs("table",{style:{width:"100%",borderCollapse:"collapse",minWidth:"600px"},children:[e.jsx("thead",{children:e.jsxs("tr",{style:{backgroundColor:"#f8fafc",borderBottom:"2px solid #e2e8f0"},children:[e.jsx("th",{style:{padding:"1rem",textAlign:"left",color:"#475569"},children:r("crop")}),e.jsx("th",{style:{padding:"1rem",textAlign:"center",color:"#475569"},children:"Unit"}),e.jsxs("th",{style:{padding:"1rem",textAlign:"right",color:"#16a34a"},children:[r("min_price")," (â‚¹)"]}),e.jsxs("th",{style:{padding:"1rem",textAlign:"right",color:"#dc2626"},children:[r("max_price")," (â‚¹)"]}),e.jsxs("th",{style:{padding:"1rem",textAlign:"right",color:"#2563eb"},children:[r("avg_price")," (â‚¹)"]})]})}),e.jsx("tbody",{children:v.length>0?v.map((t,s)=>e.jsxs("tr",{style:{borderBottom:"1px solid #e2e8f0",backgroundColor:s%2===0?"white":"#f8fafc"},children:[e.jsx("td",{style:{padding:"1rem",fontWeight:"500"},children:t.crop}),e.jsx("td",{style:{padding:"1rem",textAlign:"center",color:"#666"},children:t.unit}),e.jsx("td",{style:{padding:"1rem",textAlign:"right",fontWeight:"600"},children:t.min}),e.jsx("td",{style:{padding:"1rem",textAlign:"right",fontWeight:"600"},children:t.max}),e.jsx("td",{style:{padding:"1rem",textAlign:"right",fontWeight:"bold"},children:t.avg})]},t.id)):e.jsx("tr",{children:e.jsx("td",{colSpan:"5",style:{padding:"2rem",textAlign:"center",color:"#64748b"},children:r("no_results")||"No crops found matching search"})})})]})})]}):e.jsxs("div",{style:{textAlign:"center",padding:"3rem",backgroundColor:"#fff",borderRadius:"var(--radius-lg)",border:"2px dashed #cbd5e1"},children:[e.jsx("div",{style:{fontSize:"3rem",marginBottom:"1rem",opacity:.5},children:"ðŸ”Ž"}),e.jsx("h3",{style:{color:"#64748b",marginBottom:"0.5rem"},children:r("select_mandi_prompt")}),e.jsx("p",{style:{color:"#94a3b8"},children:r("search_btn")?r("select_mandi_prompt"):"Select location and click Search"})]}),G=()=>{if(!navigator.geolocation){alert(r("geolocation_unsupported")||"Geolocation is not supported by your browser");return}d("detecting"),navigator.geolocation.getCurrentPosition(async t=>{const{latitude:s,longitude:_}=t.coords;try{const i=await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${s}&lon=${_}&zoom=10`,{headers:{"Accept-Language":"en-US,en;q=0.9","User-Agent":"KisanBazaar-Mobile-App"}});if(!i.ok)throw new Error("Network error");const u=await i.json();if(u&&u.address){const a=u.address,Y=a.state||"",$=a.city||a.district||a.county||a.state_district||"",k=a.suburb||a.town||a.village||a.neighbourhood||a.city_district||"",{getCityToDistrict:V}=await E(()=>import("./locationMapping-e858de36.js"),[]),{getStates:O,getDistricts:q,getTehsils:K}=await E(()=>import("./index-ef4083ce.js").then(h=>h.z),["assets/index-ef4083ce.js","assets/index-a019cad9.css"]);let L=V($),p=O().find(h=>h.toLowerCase()===Y.toLowerCase())||"",n="",f="";if(p){const h=q(p);n=h.find(y=>y.toLowerCase()===L.toLowerCase())||"",n||(n=h.find(y=>y.toLowerCase().includes(L.toLowerCase())||L.toLowerCase().includes(y.toLowerCase()))||""),n&&(f=K(p,n).find(A=>A.toLowerCase()===k.toLowerCase()||A.toLowerCase().includes(k.toLowerCase())||k.toLowerCase().includes(A.toLowerCase()))||"")}p&&D(p),n&&R(n),f?w(f):n&&w(n),d("success");const x=[];f&&x.push(f),n&&x.push(n),p&&x.push(p),x.length>0?alert(`ðŸ“ Location detected: ${x.join(", ")}

Rates will load automatically.`):alert("ðŸ“ Location detected but could not match to our database. Please select manually.")}else throw new Error("Address not found")}catch(i){d("error"),alert("Unable to connect to location service. Please select manually."),console.error("Reverse Geocoding error:",i)}finally{d("")}},t=>{t.code===1?(d("permission_denied"),setTimeout(()=>d(""),3e3)):(d("error"),alert("Unable to detect location. Please select manually."),d("")),console.error("Geolocation error:",t)},{timeout:15e3,enableHighAccuracy:!0})},v=b.filter(t=>t.crop.toLowerCase().includes(j.toLowerCase()));return e.jsxs("div",{className:"container fade-in",style:{padding:"var(--spacing-xl) 0"},children:[e.jsx("h1",{style:{textAlign:"center",marginBottom:"var(--spacing-md)",color:"var(--color-primary)"},children:r("todays_rates")}),e.jsx("div",{style:{display:"flex",justifyContent:"center",gap:"1rem",marginBottom:"1.5rem"},children:e.jsxs("button",{className:"btn btn-outline",onClick:()=>S(!0),style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:["ðŸ“Š ",r("view_analysis")||"View Analysis"]})}),e.jsx("div",{className:"card",style:{marginBottom:"var(--spacing-lg)",padding:"1.5rem",backgroundColor:"#f0f9ff"},children:e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"1.5rem"},children:[e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"0.5rem"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"0.8rem"},children:[e.jsxs("label",{style:{fontWeight:"600",color:"#1e293b",margin:0},children:[r("select_location"),":"]}),e.jsx("button",{type:"button",onClick:G,disabled:l==="detecting",style:{padding:"0.4rem 0.8rem",fontSize:"0.9rem",whiteSpace:"nowrap",display:"flex",alignItems:"center",gap:"0.4rem",backgroundColor:l==="detecting"?"#f1f5f9":l==="permission_denied"?"#fee2e2":"#dcfce7",color:l==="detecting"?"#94a3b8":l==="permission_denied"?"#dc2626":"#166534",border:l==="permission_denied"?"1px solid #fca5a5":"1px solid #86efac",borderRadius:"6px",cursor:l==="detecting"?"not-allowed":"pointer",fontWeight:"600"},children:l==="detecting"?e.jsx(e.Fragment,{children:"â³ Detecting..."}):l==="permission_denied"?e.jsx(e.Fragment,{children:"ðŸš« Permission Denied"}):e.jsxs(e.Fragment,{children:["ðŸ“ ",r("nearby_mandi")||"Nearby Mandi"]})})]}),e.jsx("div",{style:{width:"100%"},children:e.jsx(J,{stateRef:m,selectedState:T,selectedDistrict:c,selectedTehsil:g,onLocationChange:t=>{t.state&&D(t.state),t.district&&R(t.district),w(t.tehsil||"")},showTehsil:!0})})]}),e.jsxs("div",{children:[e.jsxs("label",{style:{display:"block",marginBottom:"8px",fontWeight:"600",color:"#1e293b"},children:[r("search_crop"),":"]}),e.jsxs("div",{style:{position:"relative"},children:[e.jsxs("div",{style:{position:"relative",display:"flex",alignItems:"center",width:"100%",borderRadius:"var(--radius-md)",border:"1px solid #cbd5e1",backgroundColor:"white",overflow:"hidden",boxShadow:I?"0 0 0 3px rgba(34, 197, 94, 0.1)":"none",transition:"box-shadow 0.2s"},children:[e.jsx("span",{style:{paddingLeft:"12px",fontSize:"1.2rem",opacity:.6},children:"ðŸ”"}),e.jsx("input",{type:"text",placeholder:r("search_placeholder")||"Search crops...",value:j,onChange:t=>C(t.target.value),onFocus:t=>{if(!T&&!c){t.preventDefault(),t.target.blur(),alert(r("select_location_first")||"Please select a State and District first to see rates."),m.current&&(m.current.focus(),m.current.style.borderColor="red",setTimeout(()=>m.current.style.borderColor="#ccc",1e3));return}N(!0)},onBlur:()=>setTimeout(()=>N(!1),200),style:{width:"100%",padding:"0.8rem 0.5rem",border:"none",outline:"none",fontSize:"1rem",background:"transparent"}}),j&&e.jsx("button",{onClick:()=>C(""),style:{background:"none",border:"none",cursor:"pointer",padding:"0 12px",fontSize:"1.2rem",color:"#94a3b8",display:"flex",alignItems:"center",height:"100%",transition:"color 0.2s"},title:"Clear",onMouseEnter:t=>t.target.style.color="#475569",onMouseLeave:t=>t.target.style.color="#94a3b8",children:"Ã—"})]}),I&&j&&v.length>0&&e.jsxs("div",{style:{position:"absolute",top:"100%",left:0,right:0,backgroundColor:"white",border:"1px solid #e2e8f0",borderRadius:"0 0 8px 8px",marginTop:"4px",zIndex:10,boxShadow:"0 10px 15px -3px rgba(0, 0, 0, 0.1)",maxHeight:"250px",overflowY:"auto",animation:"slideDown 0.2s ease-out"},children:[e.jsx("style",{children:`
                                        @keyframes slideDown {
                                            from { opacity: 0; transform: translateY(-10px); }
                                            to { opacity: 1; transform: translateY(0); }
                                        }
                                    `}),v.map(t=>e.jsxs("div",{onClick:()=>C(t.crop),style:{padding:"12px 16px",cursor:"pointer",borderBottom:"1px solid #f1f5f9",fontSize:"0.95rem",display:"flex",justifyContent:"space-between",alignItems:"center"},onMouseEnter:s=>s.currentTarget.style.backgroundColor="#f8fafc",onMouseLeave:s=>s.currentTarget.style.backgroundColor="white",children:[e.jsx("span",{style:{fontWeight:"500",color:"#334155"},children:t.crop}),e.jsxs("span",{style:{fontSize:"0.8rem",color:"#64748b",backgroundColor:"#f1f5f9",padding:"2px 8px",borderRadius:"12px"},children:["â‚¹",t.avg,"/",t.unit]})]},t.id))]})]})]})]})}),H(),U&&e.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0,0,0,0.5)",zIndex:1e3,display:"flex",alignItems:"center",justifyContent:"center"},onClick:()=>S(!1),children:e.jsxs("div",{style:{backgroundColor:"white",padding:"2rem",borderRadius:"12px",maxWidth:"500px",width:"90%",maxHeight:"80vh",overflowY:"auto"},onClick:t=>t.stopPropagation(),children:[e.jsxs("h2",{style:{marginTop:0},children:["ðŸ“Š ",r("market_analysis_title")||"Market Analysis"," (",g||c||"General",")"]}),e.jsx("p",{style:{color:"#666"},children:r("price_trends_desc")||"Price trends for top commodities."}),e.jsxs("div",{style:{marginTop:"1rem"},children:[b.slice(0,5).map(t=>e.jsxs("div",{style:{marginBottom:"1rem",paddingBottom:"1rem",borderBottom:"1px solid #eee"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between"},children:[e.jsx("strong",{children:t.crop}),e.jsx("span",{style:{color:t.trend==="up"?"green":"red",backgroundColor:t.trend==="up"?"#e8f5e9":"#ffebee",padding:"2px 8px",borderRadius:"4px",fontSize:"0.8rem"},children:t.trend==="up"?r("trending_up")||"Trending Up":r("trending_down")||"Trending Down"})]}),e.jsx("div",{style:{fontSize:"0.9rem",color:"#555",marginTop:"4px"},children:r("avg_price_fmt",{price:t.avg,unit:t.unit}).replace("{price}",t.avg).replace("{unit}",t.unit)||`Avg: ${t.avg}`})]},t.id)),b.length===0&&e.jsx("p",{children:r("analysis_no_data")||"No data available."})]}),e.jsx("button",{className:"btn",onClick:()=>S(!1),style:{width:"100%",marginTop:"1rem",backgroundColor:"#f1f5f9",color:"#333"},children:r("close")||"Close"})]})}),e.jsx(Z,{})]})};export{se as default};
